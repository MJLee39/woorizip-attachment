FROM golang:1.22.2-alpine3.19 AS builder

ENV GO111MODULE=on \
    CGO_ENABLED=0 \
    GOOS=linux \
    GOARCH=arm64

WORKDIR /build

COPY go.mod main.go ./

# 필요한 경우 git 및 openssh 설치
RUN apk add --no-cache git openssh



RUN cat > /root/.ssh/id_rsa <<EOF
-----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----
EOF
# SSH 키를 복사하여 Docker 이미지 내에 추가
# COPY /var/lib/jenkins/.ssh/id_rsa /root/.ssh/id_rsa

# SSH 호스트 키를 인증된 호스트 목록에 추가
RUN ssh-keyscan -t rsa github.com >> /root/.ssh/known_hosts

# SSH 키 권한 설정
RUN chmod 600 /root/.ssh/id_rsa

RUN go env -w GOPRIVATE=github.com/TeamWAF

RUN go mod tidy

RUN go build -o main .

WORKDIR /dist

RUN cp /build/main .

FROM scratch

COPY --from=builder /dist/main .

ENTRYPOINT ["/main"]
